{% extends "promptly/base.html" %}

{% block page_header %}
<h2 class="fw-bold text-primary mb-4">Edit Task for: {{ project }}</h2>
{% endblock page_header %}

{% block content %}

<!-- Task Edit Card -->
<div class="card shadow-sm mb-4 card-hover">
  <div class="card-body">
    <h5 class="card-title">{{ project }}</h5>
    <p class="card-text">Edit the AI response or your notes below.</p>

    <form id="edit-task-form" action="{% url 'promptly:edit_task' task.id %}" method="post">
      {% csrf_token %}
      {{ form.as_div }}

      <!-- Form Buttons -->
      <div class="d-flex flex-wrap align-items-center mt-3">
        <button type="submit" class="btn btn-primary me-2 mb-2">Save Changes</button>
        <button type="button" id="generate-ai-btn" class="btn btn-outline-success mb-2">
          Generate AI Suggestion
        </button>
      </div>

      <!-- AI Suggestion Output -->
      <div id="ai-suggestion-output" class="markdown-content text-muted mt-3 mb-3 text-start">
        AI suggestion will appear here.
      </div>
    </form>
  </div>
</div>

<!-- Back to Project Button -->
<a href="{% url 'promptly:project' project.id %}" class="btn btn-secondary">
  ‚Üê Back to Project
</a>

<!-- AI Generator Script -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
document.getElementById('generate-ai-btn').addEventListener('click', async () => {
    const outputEl = document.getElementById('ai-suggestion-output');
    const textarea = document.querySelector('#id_text'); // Django field ID

    const prompt = textarea.value.trim();
    if(!prompt){
        alert('Please enter text first.');
        return;
    }

    outputEl.innerHTML = "<em>Generating AI suggestion...</em>";
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    try {
        const response = await fetch("{% url 'promptly:generate_ai' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": csrftoken
            },
            body: `prompt=${encodeURIComponent(prompt)}&project_id={{ project.id }}`
        });

        const data = await response.json();
        if(data.suggestion){
            const suggestionText = data.suggestion.replace(/\n{3,}/g, '\n\n').trim();
            outputEl.innerHTML = marked.parse(suggestionText);

            // Fill textarea with AI suggestion so user can save it
            textarea.value = data.suggestion;
        } else {
            outputEl.innerText = data.error || "Failed to generate suggestion.";
        }
    } catch(err){
        console.error(err);
        outputEl.innerText = "Error generating suggestion. Check console.";
    }
});
</script>

{% endblock content %}