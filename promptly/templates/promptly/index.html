{% extends 'promptly/base.html' %}

{% block page_header %}
<div class="p-5 mb-5 bg-white border rounded-3 shadow-sm position-relative">
  <div class="container py-5 text-center">
    <h1 class="display-4 fw-bold text-primary">Your Productivity, Promptly</h1>
    <p class="lead mt-3 text-secondary">
      Organize projects, track tasks, and let AI generate smart suggestions
      to help you get things done faster.
    </p>
    {% if not user.is_authenticated %}
      <a class="btn btn-primary btn-lg mt-3 me-2" href="{% url 'accounts:register' %}">
        Get Started &raquo;
      </a>
      <a class="btn btn-outline-primary btn-lg mt-3" href="#features">
        Learn More
      </a>
    {% endif %}
  </div>
</div>
{% endblock page_header %}

{% block content %}

<!-- Feature Highlights -->
<section id="features" class="container mb-5">
  <div class="row row-cols-1 row-cols-md-3 g-4 text-center">
    <div class="col">
      <a href="{% url 'promptly:projects' %}" class="text-decoration-none text-dark">
        <div class="card shadow-sm h-100 p-3">
          <div class="card-body">
            <h5 class="card-title fw-bold">Organize Projects</h5>
            <p class="card-text text-muted">
              Keep all your projects in one structured dashboard.
            </p>
          </div>
        </div>
      </a>
    </div>
    <div class="col">
      <a href="{% url 'promptly:new_project' %}" class="text-decoration-none text-dark">
        <div class="card shadow-sm h-100 p-3">
          <div class="card-body">
            <h5 class="card-title fw-bold">New Project</h5>
            <p class="card-text text-muted">
              Add new projects or tasks in seconds to stay productive.
            </p>
          </div>
        </div>
      </a>
    </div>
    <div class="col">
      <a href="{% url 'promptly:ai_suggestions' %}" class="text-decoration-none text-dark">
        <div class="card shadow-sm h-100 p-3">
          <div class="card-body">
            <h5 class="card-title fw-bold">AI Suggestions</h5>
            <p class="card-text text-muted">
              Review and organize AI generated insights with built-in search and filtering tools.
            </p>
          </div>
        </div>
      </a>
    </div>
</section>

<!-- Quick Stats -->
<section class="container text-center my-5 py-4 bg-white border rounded-3 shadow-sm">
  <h3 class="fw-bold text-primary mb-4">Your Stats</h3>
  <div class="row row-cols-1 row-cols-md-3 g-4">
    <div class="col">
      <div class="p-2">
        <h2 class="fw-bold display-6 text-dark mb-1">{{ project_count }}</h2>
        <div class="text-uppercase text-muted small fw-semibold">Projects</div>
      </div>
    </div>
    <div class="col">
      <div class="p-2 border-start border-end">
        <h2 class="fw-bold display-6 text-dark mb-1">{{ task_count }}</h2>
        <div class="text-uppercase text-muted small fw-semibold">Tasks</div>
      </div>
    </div>
    <div class="col">
      <div class="p-2">
        <h2 class="fw-bold display-6 text-dark mb-1">{{ ai_suggestions_count }}</h2>
        <div class="text-uppercase text-muted small fw-semibold">AI Suggestions</div>
      </div>
    </div>
  </div>
</section>

<!-- AI Generator -->
<section class="container mb-5">
  <h3 class="fw-bold text-primary text-center mb-4">Try AI in Action</h3>
  <div class="card shadow-sm p-4 text-center">
    <form id="ai-form">
      {% csrf_token %}
      <p id="ai-suggestion-output" class="mb-3 text-muted text-start">
        Enter a prompt below and generate an AI suggestion for your project.
      </p>
      <textarea id="ai-prompt-input" class="form-control mb-3" rows="3" placeholder="Describe your project or task..."></textarea>
      <button type="submit" class="btn btn-primary btn-lg" 
              style="background: linear-gradient(45deg, #ff6ec4, #7873f5, #4ade80, #facc15);
                    color: white; border: none;">Generate AI Suggestion</button>
    </form>
  </div>
</section>

<!-- AJAX for AI Generator -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
document.getElementById('ai-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const prompt = document.getElementById('ai-prompt-input').value.trim();
    if(!prompt){
        alert('Please enter a prompt.');
        return;
    }

    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const outputEl = document.getElementById('ai-suggestion-output');
    outputEl.innerHTML = "<em>Generating suggestion...</em>";

    try {
        const response = await fetch("{% url 'promptly:generate_ai' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": csrftoken
            },
            body: `prompt=${encodeURIComponent(prompt)}`
        });

        const data = await response.json();
        if(data.suggestion){
            // Render markdown properly
            const html = marked.parse(data.suggestion);
            outputEl.innerHTML = html;
        } else {
            outputEl.innerText = data.error || "Failed to generate suggestion.";
        }
    } catch (err) {
        console.error(err);
        outputEl.innerText = "Error generating suggestion. Check console.";
    }
});
</script>

<!-- Footer CTA -->
<section class="container text-center mb-5">
  {% if not user.is_authenticated %}
    <a class="btn btn-primary btn-lg" href="{% url 'accounts:register' %}">
      Get Started with Promptly &raquo;
    </a>
  {% endif %}
</section>

{% endblock content %}